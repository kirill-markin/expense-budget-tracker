name: Deploy to AWS

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      # Install worker deps (Lambda bundle references ../../apps/worker/)
      - name: Install dependencies
        run: |
          npm ci --prefix apps/worker
          npm ci --prefix infra/aws

      # Deploy infrastructure + Lambda
      - name: CDK deploy
        working-directory: infra/aws
        env:
          CDK_CONTEXT: ${{ secrets.CDK_CONTEXT }}
        run: |
          echo "$CDK_CONTEXT" > cdk.context.local.json
          npx cdk deploy --all --require-approval never

      # Deploy app code to EC2 via SSM
      - name: Update app on EC2
        run: |
          INSTANCE_ID=$(aws cloudformation describe-stacks \
            --stack-name ExpenseBudgetTracker \
            --query "Stacks[0].Outputs[?OutputKey=='Ec2InstanceId'].OutputValue" \
            --output text)

          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "$INSTANCE_ID" \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "cd /home/ec2-user/app",
              "git pull origin main",
              "docker compose -f infra/docker/compose.yml build",
              "docker compose -f infra/docker/compose.yml run --rm migrate",
              "docker compose -f infra/docker/compose.yml up -d web"
            ]' \
            --query "Command.CommandId" \
            --output text)

          echo "SSM Command ID: $COMMAND_ID"

          # Wait for command to complete
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            || true

          # Check result
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query "[Status, StandardOutputContent, StandardErrorContent]" \
            --output text
